<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆæƒç ç®¡ç†åå° - åˆ†è´æ£€æµ‹ä»ª</title>
  <style>
    :root {
      --primary: #667eea;
      --primary-dark: #5a6fd6;
      --secondary: #764ba2;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text: #1f2937;
      --text-light: #6b7280;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    /* Header */
    header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 { font-size: 28px; color: var(--text); margin-bottom: 8px; }
    .subtitle { color: var(--text-light); font-size: 14px; }

    /* Auth Section */
    .auth-box {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    input {
      padding: 10px 15px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: all 0.2s;
    }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    
    .input-full { width: 100%; }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--primary);
      color: white;
    }
    button:hover { filter: brightness(110%); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); }
    .btn-outline:hover { background: #f0fdfa; }

    /* Main Grid */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    @media (min-width: 768px) {
      .grid { grid-template-columns: 1fr 1.5fr; }
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* List */
    .code-list {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }

    .code-item {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    .code-item:last-child { border-bottom: none; }
    .code-item:hover { background: #f9fafb; }
    .code-item.active { background: #eff6ff; border-left: 3px solid var(--primary); }

    .code-text { font-family: 'Courier New', monospace; font-weight: 600; font-size: 14px; }

    /* Detail View */
    .detail-placeholder {
      text-align: center;
      color: var(--text-light);
      padding: 40px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .info-item label { font-size: 12px; color: var(--text-light); display: block; margin-bottom: 4px; }
    .info-item div { font-weight: 600; font-size: 14px; }

    .progress-bar {
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }
    .progress-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.3s ease;
    }
    .progress-fill.warning { background: var(--warning); }
    .progress-fill.danger { background: var(--danger); }

    .device-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 10px;
    }
    .device-table th, .device-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    .device-table th { color: var(--text-light); font-weight: 500; }
    
    .badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }
    .badge-blue { background: #dbeafe; color: #1e40af; }
    .badge-green { background: #d1fae5; color: #065f46; }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1f2937;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ” æˆæƒç æ§åˆ¶å°</h1>
      <p class="subtitle">ç”Ÿæˆæˆæƒç  Â· ç›‘æ§ä½¿ç”¨æƒ…å†µ Â· è®¾å¤‡ç®¡ç†</p>
    </header>

    <!-- ç™»å½•åŒºåŸŸ -->
    <div class="auth-box">
      <input type="password" id="adminKey" class="input-full" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥å¯ç”¨æŸ¥è¯¢åŠŸèƒ½..." value="spencer">
      <span style="font-size: 12px; color: #10b981;">âœ“ å·²é¢„å¡«é»˜è®¤å¯†ç </span>
    </div>

    <div class="grid">
      <!-- å·¦ä¾§ï¼šç”Ÿæˆåˆ—è¡¨ -->
      <div class="card">
        <div class="card-title">
          <span>ğŸ“ æˆæƒç ç”Ÿæˆ</span>
          <div style="display: flex; gap: 5px;">
            <input type="number" id="genCount" value="10" min="1" max="100" style="width: 60px;">
            <button onclick="generateCodes()" style="padding: 5px 10px; font-size: 12px;">ç”Ÿæˆ</button>
          </div>
        </div>
        
        <div class="code-list" id="codeList">
          <p style="padding: 20px; text-align: center; color: #999; font-size: 12px;">ç‚¹å‡»ç”ŸæˆæŒ‰é’®å¼€å§‹</p>
        </div>

        <div style="margin-top: 15px; display: flex; gap: 10px;">
          <button class="btn-outline" onclick="exportEnv()" style="flex: 1; font-size: 12px;">å¯¼å‡º ENV</button>
          <button class="btn-outline" onclick="copyAll()" style="flex: 1; font-size: 12px;">å¤åˆ¶å…¨éƒ¨</button>
        </div>
      </div>

      <!-- å³ä¾§ï¼šè¯¦æƒ…é¢æ¿ -->
      <div class="card">
        <div class="card-title">
          <span>ğŸ“Š è¯¦ç»†ç›‘æ§ä¿¡æ¯</span>
          <div style="display: flex; gap: 5px;">
            <input type="text" id="queryInput" placeholder="è¾“å…¥æˆæƒç æŸ¥è¯¢..." style="width: 180px;">
            <button onclick="manualQuery()" style="padding: 5px 10px; font-size: 12px;">æŸ¥è¯¢</button>
          </div>
        </div>

        <div id="detailView">
          <div class="detail-placeholder">
            <div style="font-size: 40px; margin-bottom: 10px;">ğŸ”</div>
            <p>ç‚¹å‡»å·¦ä¾§æˆæƒç <br>æˆ–åœ¨ä¸Šæ–¹è¾“å…¥æŸ¥è¯¢</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">å¤åˆ¶æˆåŠŸ</div>

  <script>
    let generatedCodes = [];
    const API_URL = '/api/verify-license'; // ç¡®ä¿è¿™ä¸ªæŒ‡å‘ä½ çš„ Vercel API åœ°å€

    // === æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆ ===
    function generateCodes() {
      const count = document.getElementById('genCount').value;
      const newCodes = [];
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      
      const now = new Date();
      const datePart = now.getFullYear() +
                      String(now.getMonth() + 1).padStart(2, '0') +
                      String(now.getDate()).padStart(2, '0');

      for (let i = 0; i < count; i++) {
        let randomPart = '';
        for (let j = 0; j < 8; j++) {
          randomPart += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        const code = (datePart + randomPart).match(/.{1,4}/g).join('-');
        newCodes.push(code);
      }

      generatedCodes = [...newCodes, ...generatedCodes]; // æ–°çš„åœ¨å‰é¢
      renderList();
    }

    function renderList() {
      const list = document.getElementById('codeList');
      list.innerHTML = generatedCodes.map(code => `
        <div class="code-item" onclick="queryCode('${code}', this)">
          <span class="code-text">${code}</span>
          <button style="padding: 2px 6px; font-size: 10px;" onclick="event.stopPropagation(); copy('${code}')">å¤åˆ¶</button>
        </div>
      `).join('');
    }

    // === æ ¸å¿ƒåŠŸèƒ½ï¼šæŸ¥è¯¢ ===
    async function queryCode(code, element) {
      // é«˜äº®é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.code-item').forEach(el => el.classList.remove('active'));
      if (element) element.classList.add('active');

      const adminKey = document.getElementById('adminKey').value;
      const detailView = document.getElementById('detailView');

      detailView.innerHTML = '<div class="detail-placeholder">â³æ­£åœ¨æŸ¥è¯¢æ•°æ®åº“...</div>';

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'query',
            licenseCode: code,
            adminKey: adminKey
          })
        });

        const json = await res.json();

        if (!json.success) {
          detailView.innerHTML = `
            <div class="detail-placeholder" style="color: var(--danger)">
              <p>âŒ æŸ¥è¯¢å¤±è´¥</p>
              <p style="font-size: 12px; margin-top: 5px;">${json.message}</p>
              ${json.message.includes('æœªæ¿€æ´»') ? '<p style="font-size: 12px; color: #999; margin-top: 10px;">è¯¥æˆæƒç å°šæœªåœ¨ä»»ä½•è®¾å¤‡ä½¿ç”¨</p>' : ''}
            </div>
          `;
          return;
        }

        renderDetail(json.data);

      } catch (err) {
        detailView.innerHTML = `<div class="detail-placeholder" style="color: var(--danger)">ç½‘ç»œè¯·æ±‚é”™è¯¯<br>${err.message}</div>`;
      }
    }

    function manualQuery() {
      const code = document.getElementById('queryInput').value.trim();
      if(code) queryCode(code);
    }

    // === æ¸²æŸ“è¯¦æƒ… ===
    function renderDetail(data) {
      const usagePercent = (data.totalDevices / data.maxDevices) * 100;
      let progressColor = 'success';
      if (usagePercent > 50) progressColor = 'warning';
      if (usagePercent >= 90) progressColor = 'danger';

      const devicesHtml = data.devices.map((dev, i) => `
        <tr>
          <td>${i + 1}</td>
          <td><span class="badge badge-blue">${dev.ua.split(' ')[0]}</span></td>
          <td>${dev.ip}</td>
          <td>${new Date(dev.lastSeen).toLocaleString()}</td>
        </tr>
      `).join('');

      document.getElementById('detailView').innerHTML = `
        <div>
          <h2 style="font-size: 20px; color: var(--primary); margin-bottom: 5px;">${data.code}</h2>
          <span class="badge badge-green">æœ‰æ•ˆæœŸè‡³: ${new Date(data.expiryDate).toLocaleDateString()}</span>
          
          <div style="margin: 20px 0;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;">
              <span>è®¾å¤‡ä½¿ç”¨æƒ…å†µ</span>
              <span>${data.totalDevices} / ${data.maxDevices}</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill ${progressColor}" style="width: ${usagePercent}%"></div>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-item">
              <label>é¦–æ¬¡æ¿€æ´»</label>
              <div>${new Date(data.generatedDate).toLocaleString()}</div>
            </div>
            <div class="info-item">
              <label>æœ€è¿‘æ´»åŠ¨</label>
              <div>${new Date(data.lastUsedTime).toLocaleString()}</div>
            </div>
          </div>

          <div style="border-top: 1px solid #e5e7eb; padding-top: 15px;">
            <h3 style="font-size: 14px; margin-bottom: 10px;">è®¾å¤‡åˆ—è¡¨è¯¦æƒ…</h3>
            <div style="max-height: 250px; overflow-y: auto;">
              <table class="device-table">
                <thead>
                  <tr>
                    <th width="30">#</th>
                    <th>è®¾å¤‡</th>
                    <th>IPåœ°å€</th>
                    <th>æœ€ååœ¨çº¿</th>
                  </tr>
                </thead>
                <tbody>
                  ${devicesHtml}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // === è¾…åŠ©å·¥å…· ===
    function copy(text) {
      navigator.clipboard.writeText(text);
      showToast(`å·²å¤åˆ¶: ${text}`);
    }

    function copyAll() {
      if(!generatedCodes.length) return;
      navigator.clipboard.writeText(generatedCodes.join('\n'));
      showToast(`å·²å¤åˆ¶ ${generatedCodes.length} ä¸ªæˆæƒç `);
    }

    function exportEnv() {
      if(!generatedCodes.length) return;
      const content = `LICENSE_CODES=${generatedCodes.join(',')}`;
      const blob = new Blob([content], {type: 'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'LICENSE_CODES.env';
      a.click();
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }
  </script>
</body>
</html>