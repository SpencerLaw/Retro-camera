# 🔍 授权码无效问题排查指南

## ❌ 问题：输入授权码提示"授权码无效或已过期"

---

## 📋 排查步骤（按顺序检查）

### ✅ 步骤1：检查Vercel环境变量

1. 登录 [Vercel Dashboard](https://vercel.com/dashboard)
2. 进入你的项目
3. 点击 **Settings** → **Environment Variables**
4. 检查是否有 `LICENSE_CODES` 这个变量

**如果没有：**
- 点击 **Add New** 添加
- Name: `LICENSE_CODES`
- Value: 你的授权码（逗号分隔）

**如果有：**
- 点击变量查看内容是否正确
- 确保选中了 **Production**、**Preview**、**Development** 三个环境

---

### ✅ 步骤2：检查授权码格式

**环境变量格式要求：**

✅ **正确格式：**
```
ABCDEFGHJKLMNPQR,WXYZ23456789HKMT,STUVWXYZABCD3456
```
或者（带连字符也可以）：
```
ABCD-EFGH-JKLM-NPQR,WXYZ-2345-6789-HKMT,STUV-WXYZ-ABCD-3456
```

❌ **错误格式：**
```
ABCD-EFGH-JKLM-NPQR WXYZ-2345-6789-HKMT  ← 不能用空格
ABCD-EFGH-JKLM-NPQR;WXYZ-2345-6789-HKMT  ← 不能用分号
ABCD-EFGH-JKLM-NPQR, WXYZ-2345-6789-HKMT ← 逗号后不能有空格
```

**重点检查：**
- ✅ 用逗号分隔
- ✅ 逗号前后没有空格
- ✅ 全部在一行内
- ✅ 每个授权码是16位字符（不含连字符）

---

### ✅ 步骤3：重新部署项目

**环境变量修改后必须重新部署！**

方法1：自动重新部署
1. 点击 **Deployments** 标签
2. 找到最新的部署
3. 点击右边的三个点 `...`
4. 选择 **Redeploy**
5. 等待部署完成（1-2分钟）

方法2：手动触发
1. 随便修改一个文件（比如README.md）
2. 提交并推送到GitHub
3. Vercel会自动部署

---

### ✅ 步骤4：查看Vercel部署日志

1. 进入 **Deployments** 标签
2. 点击最新的部署
3. 点击 **Functions** 标签
4. 找到 `api/verify-license`
5. 点击查看日志

**查找以下日志：**
```
环境变量 LICENSE_CODES: 已设置/未设置
原始值: ABCD-EFGH-JKLM-NPQR,...
解析后的授权码列表: [...]
```

如果看到 `未设置`，说明环境变量没生效，需要重新配置。

---

### ✅ 步骤5：测试授权码

**使用浏览器控制台测试：**

1. 打开你的网站
2. 按 F12 打开开发者工具
3. 切换到 **Console** 标签
4. 输入以下代码测试：

```javascript
// 测试API是否可访问
fetch('/api/verify-license', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    licenseCode: 'ABCD-EFGH-JKLM-NPQR',  // 改成你的授权码
    deviceId: 'test-device-123'
  })
})
.then(r => r.json())
.then(data => console.log('结果:', data))
.catch(err => console.error('错误:', err));
```

**预期结果：**
- 如果授权码正确：`{ success: true, message: "授权验证成功" }`
- 如果授权码错误：`{ success: false, message: "授权码无效或已过期" }`

---

## 🎯 快速测试方案

### 方案1：使用测试授权码

1. **生成一个简单的测试授权码**
   ```
   TEST1234ABCD5678
   ```

2. **添加到Vercel环境变量**
   ```
   LICENSE_CODES=TEST1234ABCD5678
   ```

3. **重新部署**

4. **测试输入**
   ```
   TEST-1234-ABCD-5678
   ```
   或者
   ```
   TEST1234ABCD5678
   ```

如果这个能成功，说明系统正常，只是你原来的授权码格式有问题。

---

### 方案2：检查授权码是否完整

打开 `tools/license-generator.html`，重新生成几个授权码：

1. 点击"生成授权码"生成5个
2. 点击"下载ENV格式"
3. 打开下载的文件
4. **完整复制** `LICENSE_CODES=` 后面的内容
5. 粘贴到Vercel环境变量的Value中
6. 保存并重新部署

---

## 🐛 常见错误示例

### 错误1：授权码不完整
```
❌ LICENSE_CODES=ABCD-EFGH-JKLM-NPQ   // 只有15位
✅ LICENSE_CODES=ABCD-EFGH-JKLM-NPQR  // 16位
```

### 错误2：多余的空格
```
❌ LICENSE_CODES=ABCD-EFGH-JKLM-NPQR, WXYZ-2345-6789-HKMT
✅ LICENSE_CODES=ABCD-EFGH-JKLM-NPQR,WXYZ-2345-6789-HKMT
```

### 错误3：环境变量没选Production
```
❌ 只选了 Development
✅ 必须选 Production + Preview + Development
```

### 错误4：修改后没重新部署
```
❌ 修改环境变量后直接测试
✅ 修改后必须 Redeploy
```

---

## 📊 最终检查清单

完成以下检查：

- [ ] Vercel中有 `LICENSE_CODES` 环境变量
- [ ] 环境变量选中了 Production
- [ ] 授权码格式正确（16位字符，逗号分隔）
- [ ] 逗号前后没有空格
- [ ] 已经重新部署项目
- [ ] 等待部署完成（看到绿色的Ready）
- [ ] 输入的授权码确实在环境变量列表中
- [ ] 输入时可以带连字符或不带（系统会自动处理）

---

## 💡 如何确认已修复

1. 打开网站
2. 点击"分贝检测仪"
3. 输入正确的授权码
4. 应该看到 "✅ 授权成功！正在启动..."
5. 自动进入分贝检测仪功能

---

## 🆘 还是不行？

请提供以下信息：

1. **Vercel环境变量截图**（隐藏具体授权码内容）
2. **你输入的授权码**（前4位即可，如：ABCD-****-****-****）
3. **浏览器控制台的错误信息**（F12 → Console标签）
4. **Vercel部署日志**（Deployments → 点击最新部署 → Functions → verify-license）

我会根据这些信息帮你进一步排查！

